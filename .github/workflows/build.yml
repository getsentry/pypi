name: build
on:
  pull_request:
  push:
    branches: [main, test-me-*]

jobs:
  linux:
    runs-on: ubuntu-latest
    container: ghcr.io/getsentry/pypi-manylinux-amd64-ci
    steps:
    - uses: actions/checkout@v3
    - run: python3 -um build --pypi-url https://pypi.devinfra.sentry.io
    - run: python3 -um validate --index-url https://pypi.devinfra.sentry.io/simple
    - uses: actions/upload-artifact@v3
      with:
        name: dist-linux
        path: dist/*
  macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - run: python3 -u docker/install-pythons --dest pythons
    - run: |
        echo "$PWD/pythons/cp38-cp38/bin" >> "$GITHUB_PATH"
        echo "$PWD/pythons/cp39-cp39/bin" >> "$GITHUB_PATH"
        echo "$PWD/pythons/cp310-cp310/bin" >> "$GITHUB_PATH"
        echo "$PWD/venv/bin" >> "$GITHUB_PATH"
    - run: python3 -um venv venv && pip install -r docker/requirements.txt
    - run: python3 -um build --pypi-url https://pypi.devinfra.sentry.io
    - run: python3 -um validate --index-url https://pypi.devinfra.sentry.io/simple
    - uses: actions/upload-artifact@v3
      with:
        name: dist-macos
        path: dist/*
